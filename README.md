# WinFirewallEvents
Powershell script to enable then reduce and display firewall ALLOW and BLOCK events auditing.  Goes quite a way towards answering the question "what firewall rule is blocking my traffic?"

Many people, including myself, want insight into how the Windows Firewall rules are affecting the software on their machines. Numerous bits of wisdom can be found online, but few coherent applications glue the constituent technologies together. In fact, some of the bits of wisdom suggest inferior approaches such as using netsh to generate the pfirewall.log file. 

This script relies on Powershell 7, but no additional external libraries/toolkits.  It is accompanied by an XML file to control the format of the output.  Both files are 100% human-readable prior to use.

In the first phase, auditing is turned on to cause the Windows Filtering Platform (WFP) to begin capturing relevant network traffic events, and the user is prompted to indicate when processing being scrutinized has completed.

Once the use directs the logic to proceed, auditing is turned back off to prevent excessive logging and/or the log wrapping around and overwriting the initial events and the analyze and report phase begins. The current state of the rules in-use by the WFP are captured to facilitate linking the captured events to the associated firewall rule. The main script processing is piping the content of the Windows Security log events through a set of functions to reduce and summarize the capture period.  Tables, stripped of duplicates and 'noise' are output as shown below.  Note that Allowed Outbounds are adorned with the company associated with the IP address recorded in the event (the DNS lookup hostname is unlikely ever to be available to us). For the author's purposes, I want to know what functionality on my system is trying to contact, obviously with privacy concerns in-mind.

NOTE: You would not normally want to leave auditing turned on for these events for an extended period.  Even if you setup the Security log for massive content without losing data, and didn't care about the system load imposed by such logging, even the reduced results can be too voluminous to convert to actionable information. You won't believe how much traffic is normally hidden from view, and how much is generated by seemingly innocuous web browsing.

Sample output:
```text
PS C:\Users\X\WindowsPowerShell> ./FirewallExceptions.ps1
Press ENTER after network operations of interest are finished:

Patience - this can take a few minutes for lengthy or complex capture sessions
Active Windows Filtering Platform ALLOW rules dumped to C:\Windows\Temp\Firewall\WFPstate_Allows.JSON

Port Bindings:

Proto Dir SPort AppPID
----- --- ----- ------
UDP   I   63378 svchost -k networkservice -p -s dnscache(2968)
TCP   O   61754 svchost -k netsvcs -p -s bits(13944)
TCP   O   61755 svchost -k netsvcs -p -s bits(13944)
UDP   I   56029 chrome(11720)
UDP   O   51895 chrome(11720)

Blocked Inbound Connections:

Proto Src        Dst            DPort Filter                             AppPID
----- ---        ---            ----- ------                             ------
UDP   LAN.212    Broadcast      17500 Port Scanning Prevention Filter    -(0)
UDP   LAN.212    LAN.255        17500 Port Scanning Prevention Filter    -(0)
UDP   LAN.151    224.0.0.251    mDNS  Query User                         svchost -k networkservice -p -s dnscache(2968)

Blocked Outbounds:

Proto Dst             DPort Filter              AppPID
----- ---             ----- ------              ------
TCP   199.232.210.172 HTTP  Default Outbound    svchost -k netsvcs -p -s bits(13944)
TCP   199.232.214.172 HTTP  Default Outbound    svchost -k netsvcs -p -s bits(13944)
TCP   157.240.241.1   HTTPS !_FB                chrome(11720)
UDP   157.240.241.17  HTTPS !_FB                chrome(11720)
TCP   157.240.241.17  HTTPS !_FB                chrome(11720)
TCP   142.250.80.97   HTTPS !_Google            chrome(11720)
TCP   157.240.241.17  HTTPS !_FB                chrome(11720)

Allowed Inbound Connections:

Allowed Outbound Connections:

Proto Src  Dst             DstNm                          DPort Filter         AppPID
----- ---  ---             -----                          ----- ------         ------
TCP   me   52.149.246.39   MSFT(Microsoft Corporation)    HTTPS @_Chromium     chrome(11720)
TCP   me   18.238.49.116   AMAZON-CF(Amazon.com, Inc.)    HTTPS @_Chromium     chrome(11720)
TCP   me   13.225.63.24    AMAZO-CF(Amazon.com, Inc.)     HTTPS @_Chromium     chrome(11720)
TCP   me   54.91.155.43    AMAZON-IAD(Amazon Data Servic… HTTPS @_Chromium     chrome(11720)
TCP   me   54.91.155.43    AMAZON-IAD(Amazon Data Servic… HTTPS @_Chromium     chrome(11720)
TCP   me   18.164.93.227   AMAZON-CF(Amazon.com, Inc.)    HTTPS @_Chromium     chrome(11720)
TCP   me   18.238.79.86    AMAZON-CF(Amazon.com, Inc.)    HTTPS @_Chromium     chrome(11720)
TCP   me   18.238.50.148   AMAZON-CF(Amazon.com, Inc.)    HTTPS @_Chromium     chrome(11720)
```
